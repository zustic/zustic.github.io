"use strict";(globalThis.webpackChunkzustic_doc=globalThis.webpackChunkzustic_doc||[]).push([[4909],{6576(e,n,r){r.r(n),r.d(n,{assets:()=>d,contentTitle:()=>l,default:()=>c,frontMatter:()=>s,metadata:()=>t,toc:()=>o});const t=JSON.parse('{"id":"tutorial-extras/query-plugins-middleware","title":"Middleware & Plugins","description":"Extend Zustic Query with middleware and plugins","source":"@site/docs/tutorial-extras/query-plugins-middleware.md","sourceDirName":"tutorial-extras","slug":"/tutorial-extras/query-plugins-middleware","permalink":"/docs/tutorial-extras/query-plugins-middleware","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/tutorial-extras/query-plugins-middleware.md","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"sidebar_position":3,"title":"Middleware & Plugins","description":"Extend Zustic Query with middleware and plugins"},"sidebar":"tutorialSidebar","previous":{"title":"Getting Started","permalink":"/docs/tutorial-extras/query-getting-started"},"next":{"title":"Advanced Features","permalink":"/docs/tutorial-extras/query-advanced"}}');var a=r(4848),i=r(8453);const s={sidebar_position:3,title:"Middleware & Plugins",description:"Extend Zustic Query with middleware and plugins"},l="Middleware & Plugins",d={},o=[{value:"Middleware System",id:"middleware-system",level:2},{value:"Middleware Signature",id:"middleware-signature",level:3},{value:"Global Middleware",id:"global-middleware",level:3},{value:"Endpoint-Specific Middleware",id:"endpoint-specific-middleware",level:3},{value:"Plugin System",id:"plugin-system",level:2},{value:"Plugin Signature",id:"plugin-signature",level:3},{value:"Global Plugins",id:"global-plugins",level:3},{value:"Advanced Middleware Patterns",id:"advanced-middleware-patterns",level:2},{value:"Rate Limiting",id:"rate-limiting",level:3},{value:"Request Deduplication",id:"request-deduplication",level:3},{value:"Request Transformation",id:"request-transformation",level:3},{value:"Response Transformation",id:"response-transformation",level:2},{value:"Complete Real-World Example",id:"complete-real-world-example",level:2}];function u(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",p:"p",pre:"pre",...(0,i.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.header,{children:(0,a.jsx)(n.h1,{id:"middleware--plugins",children:"Middleware & Plugins"})}),"\n",(0,a.jsx)(n.p,{children:"Extend Zustic Query with custom middleware and plugins."}),"\n",(0,a.jsx)(n.h2,{id:"middleware-system",children:"Middleware System"}),"\n",(0,a.jsxs)(n.p,{children:["Middleware runs in a pipeline and can transform requests/responses before reaching ",(0,a.jsx)(n.code,{children:"baseQuery"}),"."]}),"\n",(0,a.jsx)(n.h3,{id:"middleware-signature",children:"Middleware Signature"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:"type ApiMiddleware = (ctx: MiddlewareContext, next: () => Promise<any>) => Promise<any>\n\ninterface MiddlewareContext {\n  arg: any                    // Query arguments\n  def: any                    // Endpoint definition\n  get: () => any              // Get current state\n  set: (state: any) => void   // Update state\n}\n"})}),"\n",(0,a.jsx)(n.h3,{id:"global-middleware",children:"Global Middleware"}),"\n",(0,a.jsx)(n.p,{children:"Apply middleware to all endpoints:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:"import { createApi } from 'zustic/query'\n\n// Authentication middleware\nconst authMiddleware = async (ctx, next) => {\n  const token = localStorage.getItem('authToken')\n  \n  // Get query parameters\n  const params = ctx.def.queryFn(ctx.arg)\n  \n  // Add auth header\n  params.headers = {\n    ...params.headers,\n    Authorization: `Bearer ${token}`\n  }\n  \n  // Update definition\n  ctx.def.queryFn = () => params\n  \n  return next()\n}\n\n// Logging middleware\nconst loggingMiddleware = async (ctx, next) => {\n  console.log('\ud83d\udce4 Request:', ctx.arg)\n  \n  const result = await next()\n  \n  if (result.error) {\n    console.error('\u274c Error:', result.error)\n  } else {\n    console.log('\ud83d\udce5 Response:', result.data)\n  }\n  \n  return result\n}\n\nconst api = createApi({\n  baseQuery: myBaseQuery,\n  middlewares: [authMiddleware, loggingMiddleware],\n  endpoints: (builder) => ({\n    getUser: builder.query({\n      query: (id) => ({ url: `/users/${id}` })\n    })\n  })\n})\n"})}),"\n",(0,a.jsx)(n.h3,{id:"endpoint-specific-middleware",children:"Endpoint-Specific Middleware"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:"endpoints: (builder) => ({\n  getPublicData: builder.query({\n    query: () => ({ url: '/public' })\n    // Uses only global middleware\n  }),\n\n  getPrivateData: builder.query({\n    query: () => ({ url: '/private' }),\n    middlewares: [\n      async (ctx, next) => {\n        console.log('\u2b50 Fetching private data')\n        return next()\n      }\n    ]\n  })\n})\n"})}),"\n",(0,a.jsx)(n.h2,{id:"plugin-system",children:"Plugin System"}),"\n",(0,a.jsx)(n.p,{children:"Plugins hook into query lifecycle events."}),"\n",(0,a.jsx)(n.h3,{id:"plugin-signature",children:"Plugin Signature"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:"interface ApiPlugin {\n  beforeQuery?: (ctx: PluginContext) => void | Promise<void>\n  afterQuery?: (result: any, ctx: PluginContext) => void | Promise<void>\n  onError?: (error: any, ctx: PluginContext) => void | Promise<void>\n}\n\ninterface PluginContext {\n  arg: any\n  def: any\n  get: () => any\n  set: (state: any) => void\n}\n"})}),"\n",(0,a.jsx)(n.h3,{id:"global-plugins",children:"Global Plugins"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:"// Devtools plugin\nconst devtoolsPlugin = {\n  beforeQuery: (ctx) => {\n    console.log('\ud83d\udd0d Query starting:', ctx.def.type, ctx.arg)\n  },\n  afterQuery: (result, ctx) => {\n    console.log('\u2705 Query complete:', result)\n  },\n  onError: (error, ctx) => {\n    console.error('\u26a0\ufe0f Query error:', error)\n  }\n}\n\n// Analytics plugin\nconst analyticsPlugin = {\n  beforeQuery: (ctx) => {\n    analytics.track('query_started', { type: ctx.def.type })\n  },\n  afterQuery: (result, ctx) => {\n    analytics.track('query_completed', { success: !result.error })\n  }\n}\n\n// Notification plugin\nconst notificationPlugin = {\n  beforeQuery: (ctx) => {\n    if (ctx.def.type === 'mutation') {\n      toast.loading('Processing...')\n    }\n  },\n  afterQuery: (result, ctx) => {\n    if (result.data && ctx.def.type === 'mutation') {\n      toast.success('Success!')\n    }\n  },\n  onError: (error, ctx) => {\n    toast.error(`Error: ${error}`)\n  }\n}\n\nconst api = createApi({\n  baseQuery: myBaseQuery,\n  plugins: [devtoolsPlugin, analyticsPlugin, notificationPlugin],\n  endpoints: (builder) => ({\n    getUser: builder.query({\n      query: (id) => ({ url: `/users/${id}` })\n    })\n  })\n})\n"})}),"\n",(0,a.jsx)(n.h2,{id:"advanced-middleware-patterns",children:"Advanced Middleware Patterns"}),"\n",(0,a.jsx)(n.h3,{id:"rate-limiting",children:"Rate Limiting"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:"const rateLimitMiddleware = (() => {\n  let lastCallTime = 0\n  const minInterval = 500  // ms between requests\n\n  return async (ctx, next) => {\n    const now = Date.now()\n    const timeSinceLastCall = now - lastCallTime\n\n    if (timeSinceLastCall < minInterval) {\n      await new Promise(r =>\n        setTimeout(r, minInterval - timeSinceLastCall)\n      )\n    }\n\n    lastCallTime = Date.now()\n    return next()\n  }\n})()\n"})}),"\n",(0,a.jsx)(n.h3,{id:"request-deduplication",children:"Request Deduplication"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:"const deduplicationMiddleware = (() => {\n  const pendingRequests = new Map()\n\n  return async (ctx, next) => {\n    const key = JSON.stringify({ type: ctx.def.type, arg: ctx.arg })\n\n    // Return existing request if duplicate\n    if (pendingRequests.has(key)) {\n      return pendingRequests.get(key)\n    }\n\n    // Store this request\n    const promise = next()\n    pendingRequests.set(key, promise)\n\n    // Clean up after completion\n    return promise.finally(() => pendingRequests.delete(key))\n  }\n})()\n"})}),"\n",(0,a.jsx)(n.h3,{id:"request-transformation",children:"Request Transformation"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:"const transformMiddleware = async (ctx, next) => {\n  const params = ctx.def.queryFn(ctx.arg)\n\n  // Add common fields\n  if (params.body) {\n    params.body = {\n      ...params.body,\n      timestamp: new Date().toISOString(),\n      version: 'v1'\n    }\n  }\n\n  // Add headers\n  params.headers = {\n    'Content-Type': 'application/json',\n    'X-Request-ID': crypto.randomUUID(),\n    ...params.headers\n  }\n\n  ctx.def.queryFn = () => params\n  return next()\n}\n"})}),"\n",(0,a.jsx)(n.h2,{id:"response-transformation",children:"Response Transformation"}),"\n",(0,a.jsx)(n.p,{children:"Transform responses at endpoint level:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:"endpoints: (builder) => ({\n  getUser: builder.query({\n    query: (id) => ({ url: `/users/${id}` }),\n\n    // Transform successful response\n    transformResponse: (data) => {\n      return {\n        ...data,\n        name: data.name.toUpperCase(),\n        joinedAt: new Date(data.createdAt)\n      }\n    },\n\n    // Transform error\n    transformError: (error) => {\n      return `Custom error: ${error}`\n    }\n  })\n})\n"})}),"\n",(0,a.jsx)(n.h2,{id:"complete-real-world-example",children:"Complete Real-World Example"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:"import { createApi } from 'zustic/query'\n\n// Middleware: Add authentication\nconst authMiddleware = async (ctx, next) => {\n  const token = localStorage.getItem('token')\n  const params = ctx.def.queryFn(ctx.arg)\n\n  if (token) {\n    params.headers = {\n      ...params.headers,\n      Authorization: `Bearer ${token}`\n    }\n  }\n\n  ctx.def.queryFn = () => params\n  return next()\n}\n\n// Plugin: Handle errors and auth failures\nconst errorHandlerPlugin = {\n  onError: (error, ctx) => {\n    if (error.includes('401')) {\n      // Clear token and redirect to login\n      localStorage.removeItem('token')\n      window.location.href = '/login'\n    } else if (error.includes('500')) {\n      console.error('Server error:', error)\n    }\n  }\n}\n\n// Plugin: Show notifications\nconst notificationPlugin = {\n  afterQuery: (result, ctx) => {\n    if (ctx.def.type === 'mutation' && result.data) {\n      console.log('\u2705 Mutation successful')\n    }\n  },\n  onError: (error, ctx) => {\n    console.log('\u274c Error:', error)\n  }\n}\n\nconst api = createApi({\n  baseQuery: async (params) => {\n    try {\n      const res = await fetch(`https://api.example.com${params.url}`, {\n        method: params.method || 'GET',\n        headers: params.headers,\n        body: params.body ? JSON.stringify(params.body) : undefined\n      })\n\n      if (!res.ok) {\n        return { error: `HTTP ${res.status}` }\n      }\n\n      return { data: await res.json() }\n    } catch (error) {\n      return { error: error instanceof Error ? error.message : 'Unknown error' }\n    }\n  },\n\n  clashTimeout: 5 * 60 * 1000,\n  middlewares: [authMiddleware],\n  plugins: [errorHandlerPlugin, notificationPlugin],\n\n  endpoints: (builder) => ({\n    getUser: builder.query({\n      query: (id) => ({ url: `/users/${id}` })\n    }),\n\n    updateUser: builder.mutation({\n      query: (user) => ({\n        url: `/users/${user.id}`,\n        method: 'PUT',\n        body: user\n      }),\n      onSuccess: (data) => {\n        console.log('User updated:', data)\n      }\n    })\n  })\n})\n\nexport const { useGetUserQuery, useUpdateUserMutation } = api\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Next: ",(0,a.jsx)(n.a,{href:"/docs/tutorial-extras/query-advanced",children:"Advanced Features \u2192"})]})]})}function c(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(u,{...e})}):u(e)}},8453(e,n,r){r.d(n,{R:()=>s,x:()=>l});var t=r(6540);const a={},i=t.createContext(a);function s(e){const n=t.useContext(i);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:s(e.components),t.createElement(i.Provider,{value:n},e.children)}}}]);